@model List<WorkOrder>

@{
    //Issues:

    //The ejs is throwing a javascript error when validation occurs.
    //I've found out it works correctly when column validation is used
    //but when you turn on data annotation validation, it throws the javascript
    //error.

    //When I create a new record, the record is added to the Grid but the columns
    //with templates do not show correctly. I need to refresh the browser.

    //Using innerHTML when adding the partial view to the template looks terrible
    //but it looks good when JQuery().html() is used.

    ViewData["Title"] = "Work Orders";
}

<div class="text-center">
    <h1 class="display-4">Work Orders</h1>
</div>

<div>
    <ejs-grid id="work-order-grid" allowReordering="true" allowFiltering="true" allowPaging="true" allowSorting="true" showColumnChooser="true"
              toolbar="@(new List<string>() { "Add", "Delete", "Cancel", "ColumnChooser" })" actionComplete="onActionComplete" actionFailure="onActionFailure" rowDataBound="onRowDataBound">
        <e-data-manager json="@Model.ToArray()" adaptor="RemoteSaveAdaptor" insertUrl="/WorkOrder/Create" updateUrl="/WorkOrder/Update" removeUrl="/WorkOrder/Delete" />
        <e-grid-editsettings allowAdding="true" allowDeleting="true" allowEditing="true" mode="Dialog" showDeleteConfirmDialog="true" template="#work-order-dialog-template" />
        <e-grid-columns>
            <e-grid-column field="@nameof(WorkOrder.Integer64ID)" headerText="Work Order ID" isPrimaryKey="true" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.Name)" headerText="Name" validationRules="@(new { required = true })" />
            <e-grid-column field="@nameof(WorkOrder.Description)" headerText="Description" />
            <e-grid-column field="@nameof(WorkOrder.ServiceType)" headerText="Service Type" template="#service-type-column-template" validationRules="@(new { required = true })" />
            <e-grid-column field="@nameof(WorkOrder.Priority)" headerText="Priority" template="#priority-column-template" />
            <e-grid-column field="@nameof(WorkOrder.Status)" headerText="Status" template="#status-column-template" />
            <e-grid-column field="@nameof(WorkOrder.DueBy)" format="MM/dd/yyyy" headerText="Due By" type="date" />
            <e-grid-column field="@nameof(WorkOrder.Problem)" headerText="Problem" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.Resolution)" headerText="Resolution" visible="false" />
        </e-grid-columns>
        <e-grid-pagesettings pageCount="5" />
    </ejs-grid>
</div>

<style>
    .warning-row {
        background-color: darkgoldenrod;
    }

    .critical-row {
        background-color: darkred;
    }
</style>

<script id='work-order-dialog-template' type="text/x-template">
    <div id="work-order-dialog-template-root"></div>
</script>

<script id="priority-column-template" type="text/x-template">
    ${if(Priority == 0)}
        Low
    ${/if}
    ${if(Priority == 1)}
        Normal
    ${/if}
    ${if(Priority == 2)}
        High
    ${/if}
</script>

<script id="service-type-column-template" type="text/x-template">
    ${if(ServiceType == 0)}
        Inspection
    ${/if}
    ${if(ServiceType == 1)}
        Routine
    ${/if}
    ${if(ServiceType == 2)}
        Reactive
    ${/if}
    ${if(ServiceType == 3)}
        Other
    ${/if}
</script>

<script id="status-column-template" type="text/x-template">
    ${if(Status == 0)}
        Open
    ${/if}
    ${if(Status == 1)}
        In Progress
    ${/if}
    ${if(Status == 2)}
        Verify
    ${/if}
    ${if(Status == 3)}
        Closed
    ${/if}
</script>

<script>
    //The function handles loading the add/edit dialog.
    function onActionComplete(args) {
        if (args.requestType === 'beginEdit' || args.requestType === 'add') {
            var dialog = args.dialog;
            
            //Update the dialog's header based on the action.
            dialog.header = args.requestType === 'beginEdit' ? 'Edit Work Order' : 'Add Work Order';

            //Request the add partial view and load it into the template.
            if (args.requestType === 'add') {
                var ajax = new ej.base.Ajax({
                    type: 'GET',
                    url: '/WorkOrder/GetAddPartial',
                    contentType: 'application/json',
                    dataType: 'json'
                });
                ajax.send()
                .then(function (data) {
                    $('#work-order-dialog-template-root').html(data);
                    //appendElement(data, args.form);
                    
                    args.form.elements.namedItem('Name').focus();
                })
                .catch(function (xhr) {
                    //TO DO: Display an error popup.
                    console.log(xhr);
                });
            }
            //Request the edit partial view and load it into the template.
            else if (args.requestType === 'beginEdit') {
                var ajax = new ej.base.Ajax({
                    type: 'GET',
                    url: '/WorkOrder/GetEditPartial/' + args.rowData.Integer64ID,
                    contentType: 'application/json',
                    dataType: 'json'
                });
                ajax.send()
                .then(function (data) {
                    $('#work-order-dialog-template-root').html(data);
                    //appendElement(data, args.form);

                    args.form.elements.namedItem('Name').focus();
                })
                .catch(function (xhr) {
                    //TO DO: Display an error popup.
                    console.log(xhr);
                });
            }
        }
    }

    //The function handles any failures.
    async function onActionFailure(args) {
        if (args.error !== undefined && Array.isArray(args.error) && args.error.length == 1) {
             const response = args.error[0].error

             //Check for 400 (Bad Request), 409 (Conflict) & 500 (Internal Server Error) because those will return json.
             if (response.status === 400 || response.status === 409 || response.status === 500) {
                const responseBody = await response.json();

                //The server returned 400 (Bad Request) with validation problem details.
                if (response.status === 400 && responseBody.errors !== undefined) {
                    //Ideally I would like to the Grid's add/edit popup to display validation issues.
                    //I also need to handle if a ServerSideValidation or ValidationProblemDetails object is returned.
                }
                //The server responded with 409. Display the conflict message in a popup.
                else if (response.status === 409 && responseBody.ConflictMessage !== undefined) {
                    ej.popups.DialogUtility.alert({
                        title: 'Warning',
                        content: responseBody.ConflictMessage[0],
                        position: { X: 'center', Y: 'center' }
                    });
                }
                //The server returned 500 (Internal Server Error) with problem details. Display the details in a popup.
                else if (response.status === 500 && responseBody.detail !== undefined) {
                    ej.popups.DialogUtility.alert({
                        title: 'Error',
                        content: responseBody.detail,
                        position: { X: 'center', Y: 'center' }
                    });
                }
             }
        }
    }

    //The function colors the rows based on the due by.
    function onRowDataBound(args) {
        if (args.data.DueBy !== null) {
            const now = new Date();
            const today = new Date((now.getMonth() + 1) + '/' + now.getDate() + '/' + now.getFullYear())

            //Highlight critical if past the due by.
            if (today > args.data.DueBy) {
                args.row.classList.add('critical-row');
            }
            //Highlight warning if within 7 days of the due by.
            else if ((args.data.DueBy - today) / (1000 * 60 * 60 * 24) < 8) {
                args.row.classList.add('warning-row');
            }
        }
    }

    function appendElement(elementString, form) {
        //Add HTML to the div in the dialog template.
        form.querySelector('#work-order-dialog-template-root').innerHTML = elementString;

        //The next part takes the script generated for the template and moves it into the document's head.
        //I don't know why the syncfusion is doing this.
        
        // //Create a script tag on the document.
        // var script = document.createElement('script');
        // script.type = "text/javascript";

        // //Find the script tag in the dialog template.
        // var serverScript = form.querySelector('#work-order-dialog-template-root').querySelector('script');

        // //Add the dialog template's script to the document head and then, remove the dialog template's script.
        // script.textContent = serverScript.innerHTML;
        // document.head.appendChild(script);
        // serverScript.remove();
    }
</script>