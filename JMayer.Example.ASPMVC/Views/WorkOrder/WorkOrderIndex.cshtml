@model List<WorkOrder>

@{
    //Issues:

    //The ejs is throwing a javascript error when validation occurs.
    //I've found out it works correctly when column validation is used
    //but when you turn on data annotation validation, it throws the javascript
    //error.

    //When I create a new record, the record is added to the Grid but the columns
    //with templates do not show correctly. I need to refresh the browser.
    //It stopped adding to the Grid and I forget when that happened.

    //Using innerHTML when adding the partial view to the template looks terrible
    //but it looks good when JQuery().html() is used.

    ViewData["Title"] = "Work Orders";
}

<div class="text-center">
    <h1 class="display-4">Work Orders</h1>
</div>

<div>
    <ejs-grid id="work-order-grid" allowReordering="true" allowFiltering="true" allowPaging="true" allowSorting="true" showColumnChooser="true" toolbar="@(new List<string>() { "Add", "Delete", "Cancel", "ColumnChooser" })" 
            actionComplete="onActionComplete" actionFailure="onActionFailure" queryCellInfo="onQueryCellInfo" rowDataBound="onRowDataBound">
        <e-data-manager json="@Model.ToArray()" adaptor="RemoteSaveAdaptor" insertUrl="/WorkOrder/Create" updateUrl="/WorkOrder/Update" removeUrl="/WorkOrder/Delete" />
        <e-grid-editsettings allowAdding="true" allowDeleting="true" allowEditing="true" allowEditOnDblClick="false" mode="Dialog" showDeleteConfirmDialog="true" template="#work-order-dialog-template" />
        <e-grid-filtersettings showFilterBarOperator="false" />
        <e-grid-columns>
            <e-grid-column headerText="" allowFiltering="false" allowSorting="false" allowReordering="false" allowResizing="false" commands="@(new List<object> { new { type = "Edit", buttonOption = new { iconCss = "e-icons e-edit", cssClass = "e-flat" } }, new { type = "Delete", buttonOption = new { iconCss = "e-icons e-delete", cssClass = "e-flat" } } })" lockColumn="true" width="120" />
            <e-grid-column field="@nameof(WorkOrder.Integer64ID)" headerText="Work Order ID" isPrimaryKey="true" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.Name)" headerText="Name" validationRules="@(new { required = true })" />
            <e-grid-column field="@nameof(WorkOrder.Description)" headerText="Description" />
            <e-grid-column field="@nameof(WorkOrder.ServiceType)" headerText="Service Type" filterBarTemplate="@(new { create = "createServiceTypeColumnFilterDropDown", write = "writeServiceTypeColumnFilterDownDown" })" template="#service-type-column-template" validationRules="@(new { required = true })" />
            <e-grid-column field="@nameof(WorkOrder.OtherTypeOfService)" headerText="Other Type of Service" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.Priority)" headerText="Priority" filterBarTemplate="@(new { create = "createPriorityColumnFilterDropDown", write = "writePriorityColumnFilterDownDown" })" template="#priority-column-template" />
            <e-grid-column field="@nameof(WorkOrder.DueBy)" format="MM/dd/yyyy" headerText="Due By" type="date" />
            <e-grid-column field="@nameof(WorkOrder.Status)" headerText="Status" filterBarTemplate="@(new { create = "createStatusColumnFilterDropDown", write = "writeStatusColumnFilterDownDown" })" template="#status-column-template" />
            <e-grid-column field="@nameof(WorkOrder.Problem)" headerText="Problem" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.Resolution)" headerText="Resolution" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.CreatedOn)" format="MM/dd/yyyy HH:mm:sss" headerText="Created On" type="datetime" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.LastEditedOn)" format="MM/dd/yyyy HH:mm:sss" headerText="Last Edited On" type="datetime" visible="false" />
            <e-grid-column field="@nameof(WorkOrder.Status)" headerText="Status" allowReordering="false" allowResizing="false" filterBarTemplate="@(new { create = "createStatusColumnFilterDropDown", write = "writeStatusColumnFilterDownDown" })" template="#status-column-template" />
        </e-grid-columns>
        <e-grid-pagesettings pageCount="5" />
    </ejs-grid>
</div>

<style>
    .warning-row {
        background-color: darkgoldenrod;
    }

    .critical-row {
        background-color: darkred;
    }

    .next-status-icon::before {
        content: '\e87e';
    }

    .no-arrow-select {
        /* Firefox */
        -moz-appearance: none;
        /* Safari, Chrome, Opera */
        -webkit-appearance: none;
    }
</style>

<script id='work-order-dialog-template' type="text/x-template">
    <div id="work-order-dialog-template-root"></div>
</script>

<script id="priority-column-template" type="text/x-template">
    ${if(Priority == 0)}
        Low
    ${/if}
    ${if(Priority == 1)}
        Normal
    ${/if}
    ${if(Priority == 2)}
        High
    ${/if}
</script>

<script id="service-type-column-template" type="text/x-template">
    ${if(ServiceType == 0)}
        Inspection
    ${/if}
    ${if(ServiceType == 1)}
        Routine
    ${/if}
    ${if(ServiceType == 2)}
        Reactive
    ${/if}
    ${if(ServiceType == 3)}
        Other
    ${/if}
</script>

<script id="status-column-template" type="text/x-template">
    <select id="status-select" class="e-btn no-arrow-select">
        <option value="0" ${if(Status == 0)}selected${/if}>Open</option>
        <option value="1" ${if(Status == 1)}selected${/if}>In Progress</option>
        <option value="2" ${if(Status == 2)}selected${/if}>Verify</option>
        <option value="3" ${if(Status == 3)}selected${/if}>Closed</option>
    </select>
    <button id="next-status-button" class="e-btn">
        <span class="e-icons next-status-icon"></span>
    </button>
</script>

<script type="text/javascript">
    //A reference to the EJ2 instance of the work order grid.
    var ej2WorkOrderGrid = null;
    
    /*
        Globally stores the last ID of the record which had a status change using the status buttons.
        
        When a work order becomes resolved, the edit dialog is automatically opened and the user can
        enter the problem and resolution if need be. Making this happen in syncfusion requires a complex
        set of actions which are described below.
        
        When a status button is clicked, the status is updated on the record and then the grid's data
        manager is told to update its internal record and the record on the server. When that finishes,
        the grid is told to refresh itself so the status is updated on the UI. When the refresh completes,
        the onActionComplete() event handler will query the record based on the last ID stored and it will
        check the status. If the status is resolved, the grid will be told to start editing the row related
        to the last ID and this will open the edit dialog.
    */
    var lastRecordStatusChangeID = null;

    //A reference to the drop down for the priority column's filter.
    var priorityColumnFilterDropDown;
    
    //A reference to the drop down for the service type column's filter.
    var serviceTypeColumnFilterDropDown;
    
    //A reference to the drop down for the status column's filter.
    var statusColumnFilterDropDown;

    //Constants for the field names.
    const integer64IDFieldName = 'Integer64ID';
    const priorityFieldName = 'Priority';
    const serviceTypeFieldName = 'ServiceType';
    const statusFieldName = 'Status';

    //Enum for HTTP statuses.
    const httpStatus = Object.freeze({
        BAD_REQUEST: 400,
        NOT_FOUND: 404,
        CONFLICT: 409,
        INTERNAL_SERVER_ERROR: 500
    });

    //Enum for Syncfusion grid actions.
    const syncFusionGridAction = Object.freeze({
        ADD: 'add',
        BEGIN_EDIT: 'beginEdit',
        CANCEL: 'cancel',
        REFRESH: 'refresh',
        SAVE: 'save'
    });

    //Enum for the work order priorities.
    const workOrderPriority = Object.freeze({
        LOW: 0,
        NORMAL: 1,
        HIGH: 2
    });

    //Enum for the work order service types.
    const workOrderServiceType = Object.freeze({
        INSPECTION: 0,
        ROUTINE: 1,
        REACTIVE: 2,
        OTHER: 3
    });

    //Enum for the work order statuses.
    const workOrderStatus = Object.freeze({
        OPEN: 0,
        IN_PROGRESS: 1,
        RESOLVED: 2,
        CLOSED: 3
    });

    //Constant for the all value in the dropdown filter options.
    const allValue = -1;
    
    //Constants for the dropdown filter options.
    const priorityFilterOptions = [
        { Name: 'All', Value: allValue },
        { Name: 'Low', Value: workOrderPriority.LOW },
        { Name: 'Normal', Value: workOrderPriority.NORMAL },
        { Name: 'High', Value: workOrderPriority.HIGH },
    ];

    const serviceTypeFilterOptions = [
        { Name: 'All', Value: allValue },
        { Name: 'Inspection', Value: workOrderServiceType.INSPECTION },
        { Name: 'Routine', Value: workOrderServiceType.ROUTINE },
        { Name: 'Reactive', Value: workOrderServiceType.REACTIVE },
        { Name: 'Other', Value: workOrderServiceType.OTHER }
    ];

    const statusFilterOptions = [
        { Name: 'All', Value: allValue },
        { Name: 'Open', Value: workOrderStatus.OPEN },
        { Name: 'In Progress', Value: workOrderStatus.IN_PROGRESS },
        { Name: 'Resolved', Value: workOrderStatus.RESOLVED },
        { Name: 'Closed', Value: workOrderStatus.CLOSED },
    ];

    //The function creates the dropdown for the priority column filter.
    function createPriorityColumnFilterDropDown() {
        priorityColumnFilterDropDown = document.createElement('select');

        priorityFilterOptions.forEach((item) => {
            var option = document.createElement('option');
            option.value = item.Value;
            option.innerText = item.Name;
            priorityColumnFilterDropDown.appendChild(option);
        });

        return priorityColumnFilterDropDown;
    }

    //The function creates the dropdown for the service type column filter.    
    function createServiceTypeColumnFilterDropDown() {
        serviceTypeColumnFilterDropDown = document.createElement('select');

        serviceTypeFilterOptions.forEach((item) => {
            var option = document.createElement('option');
            option.value = item.Value;
            option.innerText = item.Name;
            serviceTypeColumnFilterDropDown.appendChild(option);
        });

        return serviceTypeColumnFilterDropDown;
    }

    //The function creates the dropdown for the status column filter.
    function createStatusColumnFilterDropDown() {
        statusColumnFilterDropDown = document.createElement('select');

        statusFilterOptions.forEach((item) => {
            var option = document.createElement('option');
            option.value = item.Value;
            option.innerText = item.Name;
            statusColumnFilterDropDown.appendChild(option);
        });

        return statusColumnFilterDropDown;
    }

    //The function returns the work order from the data manager based on the ID.
    function getWorkOrderFromDataManager(id) {
        var workOrderGrid = getEJ2WorkOrderGrid();
        var query = new ej.data.Query().where(integer64IDFieldName, 'equal', id);
        var queryResult = workOrderGrid.dataSource.executeLocal(query);

        if (queryResult.length === 1) {
            return queryResult[0];
        }
        else {
            return null;
        }
    }

    //The function returns the EJ2 instance for the work order grid.
    function getEJ2WorkOrderGrid() {
        if (ej2WorkOrderGrid === null) {
            ej2WorkOrderGrid = $('#work-order-grid').get(0).ej2_instances[0];
        }

        return ej2WorkOrderGrid;
    }

    //The function handles loading the add/edit dialog.
    function onActionComplete(args) {
        if (args.requestType === syncFusionGridAction.ADD || args.requestType === syncFusionGridAction.BEGIN_EDIT) {
            var dialog = args.dialog;
            
            //Update the dialog's header based on the action.
            dialog.header = args.requestType === syncFusionGridAction.BEGIN_EDIT ? 'Edit Work Order' : 'Add Work Order';

            //Create and show a spinner while the partial view loads.
            ej.popups.createSpinner({ target: args.dialog.element });
            ej.popups.showSpinner(args.dialog.element);

            //Request the add partial view and load it into the template.
            if (args.requestType === syncFusionGridAction.ADD) {
                var ajax = new ej.base.Ajax({
                    type: 'GET',
                    url: '/WorkOrder/AddPartialView',
                    contentType: 'application/json',
                    dataType: 'json'
                });
                ajax.send()
                .then((data) => {
                    $('#work-order-dialog-template-root').html(data);
                    args.form.elements.namedItem('Name').focus();
                    ej.popups.hideSpinner(args.dialog.element);
                })
                .catch((xhr) => {
                    ej.popups.hideSpinner(args.dialog.element);
                    ej.popups.DialogUtility.alert({
                        title: 'Error',
                        content: 'Failed to load the add view.',
                        position: { X: 'center', Y: 'center' }
                    });
                });
            }
            //Request the edit partial view and load it into the template.
            else if (args.requestType === syncFusionGridAction.BEGIN_EDIT) {
                var ajax = new ej.base.Ajax({
                    type: 'GET',
                    url: '/WorkOrder/EditPartialView/' + args.rowData.Integer64ID,
                    contentType: 'application/json',
                    dataType: 'json'
                });
                ajax.send()
                .then((data) => {
                    $('#work-order-dialog-template-root').html(data);
                    args.form.elements.namedItem('Name').focus();
                    ej.popups.hideSpinner(args.dialog.element);
                })
                .catch((xhr) => {
                    ej.popups.hideSpinner(args.dialog.element);
                    ej.popups.DialogUtility.alert({
                        title: 'Error',
                        content: 'Failed to load the edit view.',
                        position: { X: 'center', Y: 'center' }
                    });
                });
            }
        }
        else if (args.requestType === syncFusionGridAction.REFRESH && lastRecordStatusChangeID !== null) {
            var workOrderGrid = getEJ2WorkOrderGrid();
            var query = new ej.data.Query().where('Integer64ID', 'equal', lastRecordStatusChangeID);

            //Opening the dialog only works when its in the executeQuery() promise; 
            //when I use executeLocal() (no promise) weird behavior happens with the 
            //dialog and I think its because the Grid.refresh() promise isn't finishing 
            //before the Grid.startEdit() is called.
            workOrderGrid.dataSource.executeQuery(query)
            .then(queryResult => {
                if (queryResult.result.length === 1) {
                    var record = queryResult.result[0];

                    if (record !== null && record.Status === workOrderStatus.RESOLVED) {
                        var rowIndex = workOrderGrid.getRowIndexByPrimaryKey(lastRecordStatusChangeID);
                        workOrderGrid.selectRow(rowIndex);
                        workOrderGrid.startEdit();
                    }
                }
            });
        }
        else if (args.requestType === syncFusionGridAction.SAVE || args.requestType === syncFusionGridAction.CANCEL) {
            //Clear the last ID for the status change whenever a save or cancel occurs.
            lastRecordStatusChangeID = null;
        }
    }

    //The function handles any failures.
    async function onActionFailure(args) {
        //Display a general error if args isn't formatted correctly.
        if (args.error === undefined || !Array.isArray(args.error) || args.error.length !== 1) {
            ej.popups.DialogUtility.alert({
                title: 'Error',
                content: 'An unknown error occurred.',
                position: { X: 'center', Y: 'center' }
            });
            return;
        }

        const response = args.error[0].error;

        //Display a general error on an unexpected response.
        if (response.status !== httpStatus.BAD_REQUEST && response.status !== httpStatus.NOT_FOUND && response.status !== httpStatus.CONFLICT && response.status !== httpStatus.INTERNAL_SERVER_ERROR) {
            ej.popups.DialogUtility.alert({
                title: 'Error',
                content: 'An unknown error occurred.',
                position: { X: 'center', Y: 'center' }
            });
            return;
        }

        const responseBody = await response.json();

        //The server returned 400 (Bad Request) with validation problem details. Display the first error message in a popup.
        if (response.status === httpStatus.BAD_REQUEST && responseBody.errors !== undefined && typeof responseBody.errors === 'object' && !Array.isArray(responseBody.errors)) {
            const keys = Object.keys(responseBody.errors);
            ej.popups.DialogUtility.alert({
                title: 'Warning',
                content: responseBody.errors[keys[0]][0],
                position: { X: 'center', Y: 'center' }
            });
        }
        //The server responded with 404 (Not Found). Display the user message provided by the server in a popup.
        else if (response.status === httpStatus.NOT_FOUND && responseBody.UserMessage !== undefined && typeof responseBody.UserMessage === 'string') {
            ej.popups.DialogUtility.alert({
                title: 'Warning',
                content: responseBody.UserMessage,
                position: { X: 'center', Y: 'center' }
            });
        }
        //The server responded with 409 (Conflict). Display the user message provided by the server in a popup.
        else if (response.status === httpStatus.CONFLICT && responseBody.UserMessage !== undefined && typeof responseBody.UserMessage === 'string') {
            ej.popups.DialogUtility.alert({
                title: 'Warning',
                content: responseBody.UserMessage,
                position: { X: 'center', Y: 'center' }
            });
        }
        //The server returned 500 (Internal Server Error) with problem details. Display the details in a popup.
        else if (response.status === httpStatus.INTERNAL_SERVER_ERROR && responseBody.detail !== undefined && typeof responseBody.detail === 'string') {
            ej.popups.DialogUtility.alert({
                title: 'Error',
                content: responseBody.detail,
                position: { X: 'center', Y: 'center' }
            });
        }
        //A catch all if the server doesn't respond as expected.
        else {
            ej.popups.DialogUtility.alert({
                title: 'Error',
                content: 'An unknown error occurred.',
                position: { X: 'center', Y: 'center' }
            });
        }
    }

    //The function attaches an event handler to the status dropdown and next status button.
    function onQueryCellInfo(args) {
        if (args.column.headerText === statusFieldName) {
            //When the next status button is clicked, the record will be updated with the next status.
            args.cell.querySelector('#next-status-button').addEventListener('click', (evt) => {
                //Query the record from the data manager and update that.
                var record = getWorkOrderFromDataManager(args.data.Integer64ID);

                if (record !== null) {
                    lastRecordStatusChangeID = record.Integer64ID

                    if (record.Status < workOrderStatus.CLOSED) {
                        record.Status += 1;
                    }
                    else {
                        record.Status = workOrderStatus.OPEN;
                    }

                    updateWorkOrderInDataManager(record);
                }
                else {
                    args.data.Status = 0;
                }

                updateWorkOrderOnServer(args.data);
            });

            //When the user selects a specific status, the record will be updated with the selected status.
            args.cell.querySelector('#status-select').addEventListener('change', function (evt) {
                args.data.Status = parseInt(evt.target.value);
                updateWorkOrderOnServer(args.data);
            });
        }
    }

    //The function colors the rows based on the due by.
    function onRowDataBound(args) {
        if (args.data.Status !== workOrderStatus.CLOSED && args.data.DueBy !== null) {
            const now = new Date();
            const today = new Date((now.getMonth() + 1) + '/' + now.getDate() + '/' + now.getFullYear());

            //Highlight critical if today or past the due by.
            if (today >= args.data.DueBy) {
                args.row.classList.add('critical-row');
            }
            //Highlight warning if within 7 days of the due by.
            else if ((args.data.DueBy - today) / (1000 * 60 * 60 * 24) < 8) {
                args.row.classList.add('warning-row');
            }
        }
    }

    //The function updates the work order record on the server.
    function updateWorkOrderOnServer(record) {
        var workOrderGrid = document.getElementById('work-order-grid').ej2_instances[0];

        //See if I can use fetch() over ej ajax or see if ej ajax has more custom response handling.
        //If a conflict occurs, the user needs to be told and right now, it looks like .catch() won't work.

        var ajax = new ej.base.Ajax({
            type: 'POST',
            url: '/WorkOrder/Update',
            contentType: 'application/json',
            data: JSON.stringify({ value: record }),
            dataType: 'json'
        });
        ajax.send()
        //On success, update the edited timestamp so future updates pass conflict detection and refresh the grid.
        .then(function (data) {
            record.LastEditedOn = data.lastEditedOn;
            workOrderGrid.refresh();
        })
        //On failure, display an error message.
        .catch(function (xhr) {
    //The function updates the work order record in the grid's data manager.
    function updateWorkOrderInDataManager(record) {
        var workOrderGrid = getEJ2WorkOrderGrid();
        workOrderGrid.dataSource.update('Integer64ID', record)
        .then(() => {
            workOrderGrid.refresh();
        })
        .catch((error) => {
            ej.popups.DialogUtility.alert({
                title: 'Error',
                content: 'Failed to update the work order.',
                position: { X: 'center', Y: 'center' }
            });
        });
    }

    //The function creates the ej2 dropdown for the priority column filter and adds it to the associated select element.
    function writePriorityColumnFilterDownDown() {
        var dropDownList = new ej.dropdowns.DropDownList({
            //The filter is applied or cleared based on the selected option.
            change: (args) => {
                var grid = getEJ2WorkOrderGrid();
                var value = parseInt(args.value);

                if (value !== allValue) {
                    grid.filterByColumn(priorityFieldName, 'equal', value);
                }
                else {
                    grid.removeFilteredColsByField(priorityFieldName);
                }
            }
        });

        dropDownList.appendTo(priorityColumnFilterDropDown);
    }

    //The function creates the ej2 dropdown for the service type column filter and adds it to the associated select element.
    function writeServiceTypeColumnFilterDownDown() {
        var dropDownList = new ej.dropdowns.DropDownList({
            //The filter is applied or cleared based on the selected option.
            change: (args) => {
                var grid = getEJ2WorkOrderGrid();
                var value = parseInt(args.value);

                if (value !== allValue) {
                    grid.filterByColumn(serviceTypeFieldName, 'equal', value);
                }
                else {
                    grid.removeFilteredColsByField(serviceTypeFieldName);
                }
            }
        });

        dropDownList.appendTo(serviceTypeColumnFilterDropDown);
    }

    //The function creates the ej2 dropdown for the status column filter and adds it to the associated select element.
    function writeStatusColumnFilterDownDown() {
        var dropDownList = new ej.dropdowns.DropDownList({
            //The filter is applied or cleared based on the selected option.
            change: (args) => {
                var grid = getEJ2WorkOrderGrid();
                var value = parseInt(args.value);

                if (value !== allValue) {
                    grid.filterByColumn(statusFieldName, 'equal', value);
                }
                else {
                    grid.removeFilteredColsByField(statusFieldName);
                }
            }
        });

        dropDownList.appendTo(statusColumnFilterDropDown);
    }
</script>